{% load static %}
<div class="mobile-search-bar d-md-none bg-gradient-primary shadow-sm">
  <div class="container py-2">
    <div class="d-flex align-items-center justify-content-between mb-2">
      {# Left: optional Back + Deliver to (for guests shows generic text) #}
      <div class="d-inline-flex align-items-center text-white small me-3">
        {% if request.path != '/' %}
          <a href="/" class="btn btn-outline-light btn-sm me-2" aria-label="Go back" onclick="if (window.history && history.length > 1) { history.back(); return false; }"><i class="bi bi-arrow-left"></i></a>
        {% endif %}
        <i class="bi bi-geo-alt me-2"></i>
        <button class="btn btn-link p-0 text-white text-decoration-none d-inline-flex align-items-center" type="button" data-bs-toggle="modal" data-bs-target="#deliveryLocationModal">
          Deliver to
          <span id="deliveryLabel">
          {% if DELIVERY_SESSION %}
            &nbsp;{% if DELIVERY_SESSION.city or DELIVERY_SESSION.postal_code %}{{ DELIVERY_SESSION.city }}{% if DELIVERY_SESSION.city and DELIVERY_SESSION.postal_code %}, {% endif %}{{ DELIVERY_SESSION.postal_code }}{% else %}Using your location{% endif %}
          {% elif DEFAULT_ADDRESS %}
            &nbsp;{{ DEFAULT_ADDRESS.city }}, {{ DEFAULT_ADDRESS.postal_code }}
          {% else %}
            &nbsp;Set location
          {% endif %}
          </span>
          <i class="bi bi-caret-down-fill ms-1"></i>
        </button>
      </div>

      {# Right: Icons #}
      <div class="d-inline-flex align-items-center gap-3 ms-auto">
        <a id="notifBellLink" href="#notificationsModal" data-bs-toggle="modal" class="text-white position-relative" title="Notifications" aria-label="Notifications">
          <i class="bi bi-bell" style="font-size:1.1rem;"></i>
          {% if NOTIF_COUNT and NOTIF_COUNT > 0 %}
            <span class="badge rounded-pill bg-danger position-absolute translate-middle" style="top:0; right:-6px; font-size:.65rem;">{{ NOTIF_COUNT }}</span>
          {% endif %}
        </a>
        <a href="/wishlist/" class="text-white position-relative" title="Wishlist" aria-label="Wishlist">
          <i class="bi bi-heart" style="font-size:1.1rem;"></i>
        </a>
      </div>
    </div>
    <form class="amz-search amz-search-mobile amz--no-cat d-flex align-items-center" role="search" method="get" action="/search/">
      <div class="amz-wrap w-100">
        <img class="amz-logo-in" src="{% static BRAND_LOGO %}" alt="{{ STORE_NAME }}" onerror="this.style.display='none'" />
        <input id="mobileSearchInput" class="amz-input" type="search" name="q" placeholder='Search "Jeans"' aria-label="Search" value="{{ request.GET.q|default:'' }}" />
        <div class="amz-tools">
          <button class="amz-tool" type="button" id="voiceSearchBtnMobile" title="Voice search"><i class="bi bi-mic"></i></button>
          <button class="amz-tool" type="button" id="imageSearchBtnMobileTop" title="Search with image"><i class="bi bi-camera"></i></button>
        </div>
        <button class="amz-submit" type="submit"><i class="bi bi-search"></i></button>
      </div>
    </form>
    <form id="imageSearchFormMobileTop" method="post" action="/search/" enctype="multipart/form-data">
      {% csrf_token %}
      <input id="imageSearchInputMobileTop" type="file" name="image" accept="image/*" class="d-none" />
      <input id="imageSearchInputMobileTopCam" type="file" name="image" accept="image/*" capture="environment" class="d-none" />
    </form>
    
  </div>
</div>

{% comment %} Delivery location modal (mobile only) {% endcomment %}
<script>
  (function(){
    var examples = [
      "Jeans",
      "Trousers",
      "Chinos",
      "Shorts",
      "Shirt",
      "T-shirt",
      "Polo shirt",
      "Hoodie",
      "Sweatshirt",
      "Jacket",
      "Blazer",
      "Sweater",
      "Coat",
      "Kurta",
      "Track pants"
    ];
    var els = [document.getElementById('mobileSearchInput'), document.getElementById('desktopSearchInput')].filter(Boolean);
    var idx = Math.floor(Math.random() * examples.length);
    function rotate(){
      idx = (idx + 1) % examples.length;
      var text = 'Search "' + examples[idx] + '"';
      els.forEach(function(el){ if(el && !el.matches(':focus') && !el.value){ el.setAttribute('placeholder', text); } });
    }
    // Seed initial
    rotate();
    setInterval(rotate, 3000);
  })();
</script>
<div class="modal fade" id="deliveryLocationModal" tabindex="-1" aria-labelledby="deliveryLocationLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deliveryLocationLabel">Select delivery location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label" for="pinInput">Pincode</label>
          <div class="input-group">
            <input id="pinInput" class="form-control" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Enter pincode" />
            <button type="button" class="btn btn-primary" id="setPinBtn">Set</button>
          </div>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button type="button" class="btn btn-outline-primary" id="useCurrentLocationBtn"><i class="bi bi-geo-alt me-1"></i> Use my current location</button>
          <button type="button" class="btn btn-outline-secondary" id="searchLocationBtn"><i class="bi bi-search me-1"></i> Search location</button>
        </div>
        {% if request.user.is_authenticated and USER_ADDRESSES %}
        <div class="border-top pt-3">
          <div class="fw-semibold mb-2">Select saved address</div>
          <div class="list-group">
            {% for addr in USER_ADDRESSES %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{{ addr.full_name }}</div>
                    <div class="small text-muted">{{ addr.address_line1 }}{% if addr.address_line2 %}, {{ addr.address_line2 }}{% endif %}, {{ addr.city }}, {{ addr.state }} {{ addr.postal_code }}</div>
                    <div class="small text-muted">{{ addr.country }} Â· {{ addr.phone }}</div>
                    {% if addr.is_default %}<span class="badge bg-success mt-1">Default</span>{% endif %}
                  </div>
                  <form method="post" action="/accounts/addresses/{{ addr.id }}/default/" class="ms-3">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-primary">Deliver here</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <script>
    (function(){
      function getCsrf(){
        try {
          var name = 'csrftoken=';
          var parts = document.cookie.split(';');
          for (var i=0;i<parts.length;i++){ var p = parts[i].trim(); if (p.indexOf(name)===0) return p.substring(name.length); }
        } catch(e){}
        var inp = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return inp ? inp.value : '';
      }
      var useBtn = document.getElementById('useCurrentLocationBtn');
      if(useBtn){
        useBtn.addEventListener('click', function(){
          if(!navigator.geolocation){ alert('Geolocation is not supported on this device.'); return; }
          navigator.geolocation.getCurrentPosition(function(pos){
            var lat = pos.coords.latitude, lng = pos.coords.longitude;
            // Persist coordinates
            try { localStorage.setItem('rh_geo_lat', lat); localStorage.setItem('rh_geo_lng', lng); } catch(e){}
            // Reverse geocode to get city/postcode (best effort via OSM Nominatim)
            function finishSet(city, pin, state, country){
              try {
                var fd = new FormData();
                if (city) fd.append('city', city);
                if (pin) fd.append('postal_code', pin);
                if (state) fd.append('state', state);
                if (country) fd.append('country', country);
                fd.append('lat', String(lat));
                fd.append('lng', String(lng));
                fd.append('csrfmiddlewaretoken', getCsrf());
                fetch('/accounts/delivery/set/', { method:'POST', body: fd, credentials:'same-origin', headers:{ 'X-Requested-With':'XMLHttpRequest' } })
                  .then(function(r){ return r.json().catch(function(){ return {}; }); })
                  .then(function(){
                    try {
                      var label = ' ' + (city && pin ? (city + ', ' + pin) : (pin || city || 'Using your location'));
                      document.getElementById('deliveryLabel').textContent = label;
                      var m = document.getElementById('deliveryLocationModal'); if (m) { try { bootstrap.Modal.getInstance(m)?.hide(); } catch(_){} }
                      if (location && location.pathname && location.pathname.indexOf('/checkout')===0) setTimeout(function(){ location.reload(); }, 150);
                    } catch(_){}
                  })
                  .catch(function(){});
              } catch(_){}
            }
            try {
              var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' + encodeURIComponent(lat) + '&lon=' + encodeURIComponent(lng) + '&addressdetails=1';
              fetch(url, { method:'GET', headers: { 'Accept': 'application/json' } })
                .then(function(r){ return r.json(); })
                .then(function(j){
                  var a = j && j.address ? j.address : {};
                  var pin = a.postcode || '';
                  var city = a.city || a.town || a.village || a.suburb || a.hamlet || a.county || '';
                  var state = a.state || '';
                  var country = a.country || '';
                  finishSet(city, pin, state, country);
                })
                .catch(function(){ finishSet('', '', '', ''); });
            } catch(_) { finishSet('', '', '', ''); }
          }, function(err){ alert('Could not get location: ' + (err && err.message ? err.message : 'Permission denied')); });
        });
      }
      var searchBtn = document.getElementById('searchLocationBtn');
      if(searchBtn){ searchBtn.addEventListener('click', function(){ document.getElementById('pinInput')?.focus(); }); }
      var setPin = document.getElementById('setPinBtn');
      if(setPin){ setPin.addEventListener('click', function(){
        var pin = (document.getElementById('pinInput')||{}).value || '';
        pin = String(pin||'').trim();
        if (!pin || pin.length < 4){ alert('Please enter a valid pincode.'); return; }
        try {
          var fd = new FormData();
          fd.append('postal_code', pin);
          fd.append('csrfmiddlewaretoken', getCsrf());
          fetch('/accounts/delivery/set/', { method:'POST', body: fd, credentials:'same-origin', headers:{ 'X-Requested-With':'XMLHttpRequest' } })
            .then(function(r){ return r.json().catch(function(){ return {}; }); })
            .then(function(){ try { document.getElementById('deliveryLabel').textContent = ' ' + pin; } catch(_){}; var m = document.getElementById('deliveryLocationModal'); try { if (m) bootstrap.Modal.getInstance(m)?.hide(); } catch(_){}; if (location && location.pathname && location.pathname.indexOf('/checkout')===0) setTimeout(function(){ location.reload(); }, 150); })
            .catch(function(){});
        } catch(_){}
      }); }
    })();
  </script>
</div>

{# Notifications modal: quick view latest 5 #}
<div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationsLabel">Notifications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if NOTIF_LATEST %}
          <div class="list-group">
            {% for n in NOTIF_LATEST %}
              {% if n.id not in NOTIF_READ_IDS %}
                <a href="{{ n.link_url|default:'#' }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" data-notif-id="{{ n.id }}" data-unread="1">
                  <div class="me-3">
                    <div class="fw-semibold">{{ n.title }}</div>
                    {% if n.message %}<div class="small text-muted">{{ n.message }}</div>{% endif %}
                    <div class="small text-muted">{{ n.created_at|date:"M d, H:i" }}</div>
                  </div>
                  <span class="badge bg-warning text-dark" data-new-badge>New</span>
                </a>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">No notifications yet.</div>
        {% endif %}
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <form method="post" action="/accounts/notifications/clear/" class="m-0">
          {% csrf_token %}
          <button class="btn btn-outline-secondary">Clear notifications</button>
        </form>
        {% if NOTIF_TOTAL|default:0 > NOTIF_LATEST|length %}
          <a href="/accounts/notifications/" class="btn btn-primary">See more</a>
        {% endif %}
      </div>
    </div>
  </div>
  </div>
