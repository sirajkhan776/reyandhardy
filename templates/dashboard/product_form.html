{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="row g-3">
  <div class="col-md-3">{% include "dashboard/_nav.html" %}</div>
  <div class="col-md-9">
    <h3>{{ form_title|default:"Create Product" }}</h3>
    <form method="post" enctype="multipart/form-data" class="card card-body">
      {% csrf_token %}
      {% if form.errors or images_fs.non_form_errors or videos_fs.non_form_errors or variants_fs.non_form_errors %}
      <div class="alert alert-danger">
        <strong>Please fix the errors below.</strong>
        {% if form.non_field_errors %}
          <div class="small">{{ form.non_field_errors }}</div>
        {% endif %}
        {% if images_fs.non_form_errors %}
          <div class="small">Images: {{ images_fs.non_form_errors }}</div>
        {% endif %}
        {% if videos_fs.non_form_errors %}
          <div class="small">Videos: {{ videos_fs.non_form_errors }}</div>
        {% endif %}
        {% if variants_fs.non_form_errors %}
          <div class="small">Variants: {{ variants_fs.non_form_errors }}</div>
        {% endif %}
      </div>
      {% endif %}
      <div class="row g-3">
        <div class="col-md-8">{{ form.name.label_tag }}{{ form.name }}{% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-4">{{ form.category.label_tag }}{{ form.category }}{% if form.category.errors %}<div class="invalid-feedback d-block">{{ form.category.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-12">{{ form.description.label_tag }}{{ form.description }}{% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-3">{{ form.base_price.label_tag }}{{ form.base_price }}{% if form.base_price.errors %}<div class="invalid-feedback d-block">{{ form.base_price.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-3">{{ form.sale_price.label_tag }}{{ form.sale_price }}{% if form.sale_price.errors %}<div class="invalid-feedback d-block">{{ form.sale_price.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-2">{{ form.weight_kg.label_tag }}{{ form.weight_kg }}{% if form.weight_kg.errors %}<div class="invalid-feedback d-block">{{ form.weight_kg.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-2">{{ form.length_cm.label_tag }}{{ form.length_cm }}{% if form.length_cm.errors %}<div class="invalid-feedback d-block">{{ form.length_cm.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-2">{{ form.breadth_cm.label_tag }}{{ form.breadth_cm }}{% if form.breadth_cm.errors %}<div class="invalid-feedback d-block">{{ form.breadth_cm.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-2">{{ form.height_cm.label_tag }}{{ form.height_cm }}{% if form.height_cm.errors %}<div class="invalid-feedback d-block">{{ form.height_cm.errors|join:", " }}</div>{% endif %}</div>
        <div class="col-md-3 form-check d-flex align-items-center">{{ form.is_active }} {{ form.is_active.label_tag }}</div>
        <div class="col-md-3 form-check d-flex align-items-center">{{ form.is_best_seller }} {{ form.is_best_seller.label_tag }}</div>
      </div>

      <hr />
      <div class="d-flex align-items-center justify-content-between">
        <h6 class="text-muted m-0">Images</h6>
        <button class="btn btn-outline-primary btn-sm add-formset" data-formset="images" type="button"><i class="bi bi-plus"></i> Add image</button>
      </div>
      {{ images_fs.management_form }}
      <div id="imagesContainer" class="mt-2">
        {% for f in images_fs %}
          <div class="row g-2 align-items-end border rounded p-2 mb-2 formset-item" data-prefix="images" data-index="{{ forloop.counter0 }}">
            <div class="col-md-6">{{ f.image.label_tag }}{{ f.image }}{% if f.image.errors %}<div class="invalid-feedback d-block">{{ f.image.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-4">{{ f.alt_text.label_tag }}{{ f.alt_text }}{% if f.alt_text.errors %}<div class="invalid-feedback d-block">{{ f.alt_text.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-1 form-check">{{ f.is_primary }} {{ f.is_primary.label_tag }}</div>
            <div class="col-md-1 text-end">
              {% if images_fs.can_delete %}<span class="d-none">{{ f.DELETE }}</span>{% endif %}
              <button type="button" class="btn btn-outline-danger btn-sm remove-formset" title="Remove image"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        {% endfor %}
      </div>
      <template id="template-images">
        <div class="row g-2 align-items-end border rounded p-2 mb-2 formset-item" data-prefix="images" data-index="__prefix__">
          <div class="col-md-6">{{ images_fs.empty_form.image.label_tag }}{{ images_fs.empty_form.image }}</div>
          <div class="col-md-4">{{ images_fs.empty_form.alt_text.label_tag }}{{ images_fs.empty_form.alt_text }}</div>
          <div class="col-md-1 form-check">{{ images_fs.empty_form.is_primary }} {{ images_fs.empty_form.is_primary.label_tag }}</div>
          <div class="col-md-1 text-end">
            {% if images_fs.can_delete %}<span class="d-none">{{ images_fs.empty_form.DELETE }}</span>{% endif %}
            <button type="button" class="btn btn-outline-danger btn-sm remove-formset" title="Remove image"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </template>

      <hr />
      <div class="d-flex align-items-center justify-content-between">
        <h6 class="text-muted m-0">Videos</h6>
        <button class="btn btn-outline-primary btn-sm add-formset" data-formset="videos" type="button"><i class="bi bi-plus"></i> Add video</button>
      </div>
      {{ videos_fs.management_form }}
      <div id="videosContainer" class="mt-2">
        {% for f in videos_fs %}
          <div class="row g-2 align-items-end border rounded p-2 mb-2 formset-item" data-prefix="videos" data-index="{{ forloop.counter0 }}">
            <div class="col-md-10">{{ f.video.label_tag }}{{ f.video }}{% if f.video.errors %}<div class="invalid-feedback d-block">{{ f.video.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-2 text-end">
              {% if videos_fs.can_delete %}<span class="d-none">{{ f.DELETE }}</span>{% endif %}
              <button type="button" class="btn btn-outline-danger btn-sm remove-formset" title="Remove video"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        {% endfor %}
      </div>
      <template id="template-videos">
        <div class="row g-2 align-items-end border rounded p-2 mb-2 formset-item" data-prefix="videos" data-index="__prefix__">
          <div class="col-md-10">{{ videos_fs.empty_form.video.label_tag }}{{ videos_fs.empty_form.video }}</div>
          <div class="col-md-2 text-end">
            {% if videos_fs.can_delete %}<span class="d-none">{{ videos_fs.empty_form.DELETE }}</span>{% endif %}
            <button type="button" class="btn btn-outline-danger btn-sm remove-formset" title="Remove video"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </template>

      <hr />
      <div class="d-flex align-items-center justify-content-between">
        <h6 class="text-muted m-0">Variants</h6>
        <button class="btn btn-outline-primary btn-sm add-formset" data-formset="variants" type="button"><i class="bi bi-plus"></i> Add variant</button>
      </div>
      {{ variants_fs.management_form }}
      <div id="variantsContainer" class="mt-2">
        {% for f in variants_fs %}
          <div class="row g-2 align-items-end border rounded p-2 mb-2 formset-item" data-prefix="variants" data-index="{{ forloop.counter0 }}">
            <div class="col-md-2">{{ f.size.label_tag }}{{ f.size }}{% if f.size.errors %}<div class="invalid-feedback d-block">{{ f.size.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-3">{{ f.color.label_tag }}{{ f.color }}{% if f.color.errors %}<div class="invalid-feedback d-block">{{ f.color.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-3">{{ f.sku.label_tag }}{{ f.sku }}{% if f.sku.errors %}<div class="invalid-feedback d-block">{{ f.sku.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-2">{{ f.stock.label_tag }}{{ f.stock }}{% if f.stock.errors %}<div class="invalid-feedback d-block">{{ f.stock.errors|join:", " }}</div>{% endif %}</div>
            <div class="col-md-2 text-end">
              {% if variants_fs.can_delete %}<span class="d-none">{{ f.DELETE }}</span>{% endif %}
              <button type="button" class="btn btn-outline-danger btn-sm remove-formset" title="Remove variant"><i class="bi bi-trash"></i></button>
            </div>
            <div class="col-12">
              <div class="row g-2">
            <div class="col-md-2">{{ f.cost_price.label_tag }}{{ f.cost_price }}</div>
            <div class="col-md-2">{{ f.weight_kg.label_tag }}{{ f.weight_kg }}</div>
            <div class="col-md-2">{{ f.length_cm.label_tag }}{{ f.length_cm }}</div>
            <div class="col-md-2">{{ f.breadth_cm.label_tag }}{{ f.breadth_cm }}</div>
            <div class="col-md-2">{{ f.height_cm.label_tag }}{{ f.height_cm }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <template id="template-variants">
        <div class="row g-2 align-items-end border rounded p-2 mb-2 formset-item" data-prefix="variants" data-index="__prefix__">
          <div class="col-md-2">{{ variants_fs.empty_form.size.label_tag }}{{ variants_fs.empty_form.size }}</div>
          <div class="col-md-3">{{ variants_fs.empty_form.color.label_tag }}{{ variants_fs.empty_form.color }}</div>
          <div class="col-md-3">{{ variants_fs.empty_form.sku.label_tag }}{{ variants_fs.empty_form.sku }}</div>
          <div class="col-md-2">{{ variants_fs.empty_form.stock.label_tag }}{{ variants_fs.empty_form.stock }}</div>
          <div class="col-md-2 text-end">
            {% if variants_fs.can_delete %}<span class="d-none">{{ variants_fs.empty_form.DELETE }}</span>{% endif %}
            <button type="button" class="btn btn-outline-danger btn-sm remove-formset" title="Remove variant"><i class="bi bi-trash"></i></button>
          </div>
          <div class="col-12">
            <div class="row g-2">
              <div class="col-md-2">{{ variants_fs.empty_form.cost_price.label_tag }}{{ variants_fs.empty_form.cost_price }}</div>
              <div class="col-md-2">{{ variants_fs.empty_form.weight_kg.label_tag }}{{ variants_fs.empty_form.weight_kg }}</div>
              <div class="col-md-2">{{ variants_fs.empty_form.length_cm.label_tag }}{{ variants_fs.empty_form.length_cm }}</div>
              <div class="col-md-2">{{ variants_fs.empty_form.breadth_cm.label_tag }}{{ variants_fs.empty_form.breadth_cm }}</div>
              <div class="col-md-2">{{ variants_fs.empty_form.height_cm.label_tag }}{{ variants_fs.empty_form.height_cm }}</div>
            </div>
          </div>
        </div>
      </template>

      <div class="mt-3">
        <button class="btn btn-primary" type="submit">{{ submit_label|default:"Create Product" }}</button>
        <a class="btn btn-outline-secondary" href="/dashboard/products/">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script src="{% static 'js/product_formsets.js' %}"></script>
{% endblock %}
