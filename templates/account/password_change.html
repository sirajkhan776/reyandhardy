{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
  <!-- Mobile back button -->
  <div class="d-md-none mb-2">
    <a href="/accounts/profile/" class="btn btn-outline-secondary btn-sm" aria-label="Go back" onclick="if (window.history && history.length > 1) { history.back(); return false; }">
      <i class="bi bi-arrow-left"></i> Back
    </a>
  </div>
  <div class="row justify-content-center">
    <div class="col-md-7 col-lg-6">
      <div class="card shadow auth-card">
        <div class="card-body p-4">
          <div class="text-center mb-3">
            <img src="{% static BRAND_LOGO %}" alt="{{ STORE_NAME }}" height="44" class="logo-img mb-2" onerror="this.style.display='none'" />
            <h3 class="mb-0">Change password</h3>
            <div class="text-muted small">Keep your account secure</div>
          </div>

          <form method="post" action="{% url 'account_change_password' %}">
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="mb-3">
              <label class="form-label" for="id_oldpassword">Current password</label>
              <div class="input-group">
                {% render_field form.oldpassword class+="form-control" autocomplete="current-password" %}
                <button type="button" class="btn btn-outline-secondary toggle-password" data-target="id_oldpassword" aria-label="Show password"><i class="bi bi-eye"></i></button>
              </div>
              {% if form.oldpassword.errors %}<div class="text-danger small">{{ form.oldpassword.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_password1">New password</label>
              <div class="input-group">
                {% render_field form.password1 class+="form-control" autocomplete="new-password" %}
                <button type="button" class="btn btn-outline-secondary toggle-password" data-target="id_password1" aria-label="Show password"><i class="bi bi-eye"></i></button>
              </div>
              {% if form.password1.help_text %}<div class="form-text">{{ form.password1.help_text|safe }}</div>{% endif %}
              {% if form.password1.errors %}<div class="text-danger small">{{ form.password1.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_password2">Confirm new password</label>
              <div class="input-group">
                {% render_field form.password2 class+="form-control" autocomplete="new-password" %}
                <button type="button" class="btn btn-outline-secondary toggle-password" data-target="id_password2" aria-label="Show password"><i class="bi bi-eye"></i></button>
              </div>
              {% if form.password2.errors %}<div class="text-danger small">{{ form.password2.errors|striptags }}</div>{% endif %}
            </div>

            <div class="d-grid gap-2">
              <button class="btn btn-gradient" type="submit">Update password</button>
              <a class="btn btn-outline-secondary" href="/accounts/profile/">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/password_toggle.js' %}"></script>
<script>
  function togglePwd(btn){
    var id = btn.getAttribute('data-target');
    var input = id ? document.getElementById(id) : null;
    if(!input){ var g = btn.closest('.input-group'); if(g) input = g.querySelector('input'); }
    if(!input) return false;
    if(input.type === 'password'){
      input.type = 'text';
      var icon = btn.querySelector('i'); if(icon){ icon.classList.remove('bi-eye'); icon.classList.add('bi-eye-slash'); }
      btn.setAttribute('aria-label','Hide password');
    } else {
      input.type = 'password';
      var icon2 = btn.querySelector('i'); if(icon2){ icon2.classList.remove('bi-eye-slash'); icon2.classList.add('bi-eye'); }
      btn.setAttribute('aria-label','Show password');
    }
    return false;
  }
</script>
{% endblock %}

