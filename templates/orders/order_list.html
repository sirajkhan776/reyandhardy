{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Your Orders</h2>
    {% if orders %}<div class="text-muted small">{{ orders|length }} order{% if orders|length != 1 %}s{% endif %}</div>{% endif %}
  </div>
  {% if orders %}
    <div class="row g-3">
      {% for o in orders %}
      <div class="col-12">
        <div class="card premium-order-card">
          <div class="card-body d-flex align-items-center">
            <div class="order-thumb me-3">
              {% with it=o.items.all.0 %}
                {% if it and it.product.images.all.0 %}
                  <a href="/order/{{ o.order_number }}/" class="d-inline-block"><img src="{{ it.product.images.all.0.image.url }}" alt="{{ it.product.name }}" class="img-fluid rounded" style="height:64px; width:64px; object-fit:cover;" /></a>
                {% else %}
                  <div class="d-flex align-items-center justify-content-center bg-light rounded" style="height:64px; width:64px;">â€”</div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="flex-grow-1">
              <div class="order-meta d-flex justify-content-between flex-wrap">
                <div>
                  <div class="fw-semibold">Order #{{ o.order_number }}</div>
                  <div class="small text-muted">Placed on {{ o.created_at|date:"d M Y, H:i" }}</div>
                </div>
                <div class="order-meta-right text-end">
                  <div class="fw-semibold">{{ CURRENCY_SYMBOL }}{{ o.total_amount }}</div>
                  <div>
                    {% if o.status == 'delivered' %}<span class="badge bg-primary">Delivered</span>
                    {% elif o.status == 'out_for_delivery' %}<span class="badge bg-info">Out for delivery</span>
                    {% elif o.status == 'dispatched' or o.status == 'shipped' %}<span class="badge bg-info">Dispatched</span>
                    {% elif o.status == 'packed' %}<span class="badge bg-secondary">Packed</span>
                    {% elif o.status == 'confirmed' or o.status == 'paid' %}<span class="badge bg-success">Confirmed</span>
                    {% elif o.status == 'cancelled' %}<span class="badge bg-danger">Cancelled</span>
                    {% elif o.status == 'refunded' %}<span class="badge bg-warning text-dark">Refunded</span>
                    {% else %}<span class="badge bg-secondary">Placed</span>{% endif %}
                  </div>
                </div>
              </div>
              {# tracker removed on listing; shown on order detail only #}
              <div class="order-actions d-flex gap-2 mt-2">
                <a href="/order/{{ o.order_number }}/" class="btn btn-sm btn-gradient">View Details</a>
                {% if o.tracking_number %}
                  <a href="{% url 'order_track' o.order_number %}" class="btn btn-sm btn-outline-primary">Track</a>
                {% endif %}
                {% if o.status == 'delivered' %}
                  <a href="{% url 'order_return_request' o.order_number %}" class="btn btn-sm btn-outline-secondary">Return / Exchange</a>
                {% endif %}
                <a href="{% url 'order_support' o.order_number %}" class="btn btn-sm btn-outline-light">Get help</a>
              </div>
              {% if o.status == 'delivered' %}
              <div class="order-rate mt-3">
                <style>
                  .rh-stars .star { background:none; border:0; padding:0 2px; line-height:1; }
                  .rh-stars .star i { font-size: 1.25rem; }
                </style>
                {% for it in o.items.all %}
                  <form class="rate-form mb-2" data-product-id="{{ it.product.id }}" data-next-url="{% url 'order_list' %}">
                    <input type="hidden" name="rating" value="0" />
                    <div class="d-flex align-items-center justify-content-start">
                      <div class="rh-stars" aria-label="Rate this product">
                        <button type="button" class="star" data-val="1" aria-label="1 star"><i class="bi bi-star"></i></button>
                        <button type="button" class="star" data-val="2" aria-label="2 stars"><i class="bi bi-star"></i></button>
                        <button type="button" class="star" data-val="3" aria-label="3 stars"><i class="bi bi-star"></i></button>
                        <button type="button" class="star" data-val="4" aria-label="4 stars"><i class="bi bi-star"></i></button>
                        <button type="button" class="star" data-val="5" aria-label="5 stars"><i class="bi bi-star"></i></button>
                      </div>
                    </div>
                    <div class="mt-2">
                      <a class="btn btn-primary btn-sm d-none review-link" href="#">Write a Review</a>
                    </div>
                  </form>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <h5>No orders yet.</h5>
      <a href="/" class="btn btn-primary mt-2">Start Shopping</a>
    </div>
  {% endif %}
{% endblock %}
{% block scripts %}
<script>
  // Inline rating behavior: after selecting stars, show a button to open dedicated review page
  (function(){
    document.addEventListener('click', function(e){
      var btn = e.target.closest('.rate-form .star');
      if (!btn) return;
      e.preventDefault();
      var form = btn.closest('.rate-form');
      if (!form) return;
      var val = parseInt(btn.getAttribute('data-val') || '0', 10);
      if (!val) return;
      var input = form.querySelector('input[name="rating"]');
      if (input) input.value = String(val);
      // Update star icons
      form.querySelectorAll('.star').forEach(function(st){
        var v = parseInt(st.getAttribute('data-val') || '0', 10);
        var i = st.querySelector('i');
        if (!i) return;
        i.className = (v <= val) ? 'bi bi-star-fill text-warning' : 'bi bi-star';
      });
      var link = form.querySelector('.review-link');
      if (!link) return;
      var pid = form.getAttribute('data-product-id');
      var next = form.getAttribute('data-next-url') || '';
      var url = '/reviews/write/' + encodeURIComponent(pid) + '/?rating=' + encodeURIComponent(String(val));
      if (next) url += '&next=' + encodeURIComponent(next);
      link.href = url;
      link.classList.remove('d-none');
    });
  })();
</script>
{% endblock %}
