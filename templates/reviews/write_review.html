{% extends "base.html" %}
{% block content %}
  <div class="container py-3">
    <h3 class="mb-3">Add Photos & Write Review</h3>

    <!-- Product and rating summary -->
    <div class="card mb-3">
      <div class="card-body d-flex gap-3 align-items-start">
        {% if thumb %}
          <img src="{{ thumb }}" alt="{{ product.name }}" class="rounded" style="width:80px;height:80px;object-fit:cover;" />
        {% endif %}
        <div class="flex-grow-1">
          <div class="fw-semibold">{{ product.name }}</div>
          {% if product.description %}
            <div class="text-muted small">{{ product.description }}</div>
          {% endif %}
          {% if rating %}
          <div class="mt-2">
            <span class="me-2">Your rating:</span>
            {% for i in "12345" %}
              {% if forloop.counter <= rating %}
                <i class="bi bi-star-fill text-warning"></i>
              {% else %}
                <i class="bi bi-star"></i>
              {% endif %}
            {% endfor %}
            {% if rating_label %}
              <span class="ms-2">{{ rating_emoji }} {{ rating_label }}</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <form method="post" action="/reviews/add/{{ product.id }}/" enctype="multipart/form-data" id="writeReviewForm">
      {% csrf_token %}
      <input type="hidden" name="rating" value="{{ rating|default:0 }}" />
      {% if next %}<input type="hidden" name="next" value="{{ next }}" />{% endif %}

      <!-- Photo & Video section -->
      <div class="card mb-3">
        <div class="card-header">Photo & Video</div>
        <div class="card-body">
          <div class="text-muted mb-2">Capture and add your product experiences with photos or videos</div>
          <div class="d-flex gap-3 flex-wrap">
            <label class="d-inline-flex flex-column align-items-center justify-content-center border rounded" style="width:140px;height:120px;cursor:pointer;">
              <div class="fw-semibold">Add photos</div>
              <div class="small text-muted">(up to 4)</div>
              <input type="file" name="photos" accept="image/*" multiple class="d-none" id="photosInput">
            </label>
            <label class="d-inline-flex flex-column align-items-center justify-content-center border rounded" style="width:140px;height:120px;cursor:pointer;">
              <div class="fw-semibold">Add a video</div>
              <div class="small text-muted">[1 min | 200 MB]</div>
              <input type="file" name="video" accept="video/*" class="d-none" id="videoInput">
            </label>
          </div>
          <div id="photoPreviews" class="d-flex gap-2 flex-wrap mt-2"></div>
          <div id="videoPreview" class="mt-2"></div>
        </div>
      </div>

      <!-- Review text section -->
      <div class="card mb-3">
        <div class="card-header">Review Text and Description</div>
        <div class="card-body">
          <input type="text" name="title" class="form-control mb-2" placeholder="Title (optional)" />
          <textarea name="body" class="form-control" rows="4" placeholder="Add description about the product"></textarea>
          <div class="form-text mt-1">
            <i class="bi bi-lightbulb-fill me-1 text-warning" aria-hidden="true"></i>
            Share helpful details: fit and sizing (tight/loose/true to size), fabric and build quality, color accuracy vs photos, comfort and breathability, durability after a few washes, and how you used it. Photos in natural light work best. Short videos (up to 1 minute) help show movement and texture.
          </div>
        </div>
      </div>

      <div class="small text-muted mb-3">By submitting this review, you give us consent to publish and process information in accordance with the Terms of Use and Privacy Policy.</div>
      <button class="btn btn-primary">Submit</button>
    </form>
  </div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    // Photos: preview up to 4, enforce selection limit client-side
    var photos = document.getElementById('photosInput');
    var photoPreviews = document.getElementById('photoPreviews');
    var video = document.getElementById('videoInput');
    var videoPreview = document.getElementById('videoPreview');
    function clear(node){ while(node && node.firstChild){ node.removeChild(node.firstChild); } }
    if (photos){
      photos.addEventListener('change', function(){
        clear(photoPreviews);
        var files = Array.prototype.slice.call(photos.files || []);
        if (files.length > 4){ files = files.slice(0,4); }
        files.forEach(function(f){
          try {
            var url = URL.createObjectURL(f);
            var img = document.createElement('img');
            img.src = url; img.alt = 'preview'; img.style.width='80px'; img.style.height='60px'; img.style.objectFit='cover'; img.className='rounded border';
            photoPreviews.appendChild(img);
          } catch(_){}
        });
      });
    }
    if (video){
      video.addEventListener('change', function(){
        clear(videoPreview);
        var f = (video.files || [])[0];
        if (!f) return;
        try {
          var url = URL.createObjectURL(f);
          var el = document.createElement('video');
          el.controls = true; el.style.maxWidth='240px'; el.style.maxHeight='160px'; el.className='rounded border';
          var source = document.createElement('source'); source.src = url; el.appendChild(source);
          videoPreview.appendChild(el);
        } catch(_){}
      });
    }
  })();
</script>
{% endblock %}
