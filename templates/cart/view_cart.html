{% extends "base.html" %}
{% block content %}
  <h2 class="mb-3">Your Cart</h2>

  {% if cart_items %}
  <div class="row g-4">
    <div class="col-lg-8">
      <!-- Mobile stacked list -->
      <div class="d-block d-md-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" data-sel-all>
            <label class="form-check-label small">Select all</label>
          </div>
          <div class="small text-muted">Selected: <span class="selCount">0</span></div>
        </div>
        <ul class="list-group list-group-flush">
          {% for item in cart_items %}
            <li class="list-group-item cart-row cart-mobile-item" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="{% if item.db_item_id %}db:{{ item.db_item_id }}{% else %}sv:{{ item.product.id }}:{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}{% endif %}" id="sel_m_{{ forloop.counter }}" form="selectForm" name="sel">
                <label class="form-check-label small" for="sel_m_{{ forloop.counter }}">Select</label>
              </div>
              <div class="d-flex gap-2 align-items-start">
                <div class="cart-media d-flex flex-column align-items-center">
                  {% with img=item.product.images.all.0 %}
                  <a href="/product/{{ item.product.slug }}/" class="cart-thumb" data-preview="{% if img %}{{ img.image.url }}{% endif %}">
                    {% if img %}
                      <img src="{{ img.image.url }}" alt="{{ item.product.name }}" />
                    {% else %}
                      <span class="cart-thumb-ph"></span>
                    {% endif %}
                  </a>
                  {% endwith %}
                  <form method="post" action="/cart/update/{{ item.db_item_id|default:0 }}/" class="cart-qty-form mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ item.product.id }}" />
                    <input type="hidden" name="variant_id" value="{% if item.variant %}{{ item.variant.id }}{% endif %}" />
                    <div class="qty-stepper">
                      <button type="button" class="btn btn-outline-secondary btn-sm qty-dec" aria-label="Decrease quantity">−</button>
                      <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control cart-qty-input text-center" />
                      <button type="button" class="btn btn-outline-secondary btn-sm qty-inc" aria-label="Increase quantity">+</button>
                    </div>
                  </form>
                </div>
                <div class="flex-grow-1 min-w-0">
                  <div class="d-flex justify-content-between align-items-start gap-2">
                    <a href="/product/{{ item.product.slug }}/" class="text-decoration-none fw-semibold cart-item-title">{{ item.product.name }}</a>
                    <div class="cart-price fw-semibold text-nowrap">{{ CURRENCY_SYMBOL }}<span class="lt" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">{{ item.line_total }}</span></div>
                  </div>
                  <div class="small text-muted mt-1">
                    {% if item.variant %}
                      <form method="post" action="/cart/update-variant/{{ item.db_item_id|default:0 }}/" class="d-flex align-items-center gap-2">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ item.product.id }}" />
                        <input type="hidden" name="variant_id" value="{% if item.variant %}{{ item.variant.id }}{% endif %}" />
                        <label class="me-1">Size</label>
                        <select name="size" class="form-select form-select-sm" style="width:auto;">
                          {% for s in item.size_options %}
                            <option value="{{ s }}"{% if s == item.variant.size %} selected{% endif %}>{{ s }}</option>
                          {% endfor %}
                        </select>
                        <span class="badge bg-dark">{{ item.variant.color }}</span>
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                      </form>
                    {% else %}No variant{% endif %}
                  </div>
                  <div class="cart-action-links d-flex justify-content-end align-items-center gap-3 mt-2">
                    <a href="/cart/save/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                       class="btn btn-sm btn-outline-secondary">Save for later</a>
                    <a href="/cart/remove/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                       class="btn btn-sm btn-outline-danger cart-remove"
                       data-action="/cart/remove/{{ item.db_item_id|default:0 }}/"
                       data-pid="{{ item.product.id }}"
                       data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">Remove</a>
                  </div>
                  <div class="small text-muted mt-1">{{ CURRENCY_SYMBOL }}{{ item.unit_price }} each</div>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Desktop table -->
      <div class="card d-none d-md-block">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" data-sel-all>
              <label class="form-check-label small">Select all</label>
            </div>
            <div class="small text-muted">Selected: <span class="selCount">0</span></div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr><th style="width:48px"></th><th>Product</th><th>Variant</th><th style="width:200px">Qty</th><th>Price</th><th>Total</th><th></th></tr>
              </thead>
              <tbody>
                {% for item in cart_items %}
                  <tr class="cart-row" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">
                    <td>
                      <input class="form-check-input" type="checkbox" value="{% if item.db_item_id %}db:{{ item.db_item_id }}{% else %}sv:{{ item.product.id }}:{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}{% endif %}" id="sel_d_{{ forloop.counter }}" form="selectForm" name="sel">
                    </td>
                    <td><a href="/product/{{ item.product.slug }}/" class="text-decoration-none">{{ item.product.name }}</a></td>
                    <td>
                      {% if item.variant %}
                        <div class="d-flex align-items-center gap-2">
                          <form method="post" action="/cart/update-variant/{{ item.db_item_id|default:0 }}/" class="d-flex align-items-center gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ item.product.id }}" />
                            <input type="hidden" name="variant_id" value="{{ item.variant.id }}" />
                            <select name="size" class="form-select form-select-sm" style="width:auto;">
                              {% for s in item.size_options %}
                                <option value="{{ s }}"{% if s == item.variant.size %} selected{% endif %}>{{ s }}</option>
                              {% endfor %}
                            </select>
                            <span class="badge bg-dark">{{ item.variant.color }}</span>
                            <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                          </form>
                        </div>
                      {% else %}-{% endif %}
                    </td>
                    <td>
                      <form method="post" action="/cart/update/{{ item.db_item_id|default:0 }}/" class="d-flex cart-qty-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ item.product.id }}" />
                        <input type="hidden" name="variant_id" value="{% if item.variant %}{{ item.variant.id }}{% endif %}" />
                        <div class="qty-stepper">
                          <button type="button" class="btn btn-outline-secondary btn-sm qty-dec" aria-label="Decrease quantity">−</button>
                          <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control cart-qty-input text-center" />
                          <button type="button" class="btn btn-outline-secondary btn-sm qty-inc" aria-label="Increase quantity">+</button>
                        </div>
                      </form>
                    </td>
                    <td class="text-nowrap">{{ CURRENCY_SYMBOL }}{{ item.unit_price }}</td>
                    <td class="text-nowrap fw-semibold">{{ CURRENCY_SYMBOL }}<span class="lt" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">{{ item.line_total }}</span></td>
                    <td class="text-end">
                      <a href="/cart/save/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                         class="btn btn-sm btn-outline-secondary">Save for later</a>
                      <a href="/cart/remove/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                         class="btn btn-sm btn-outline-danger cart-remove"
                         data-action="/cart/remove/{{ item.db_item_id|default:0 }}/"
                         data-pid="{{ item.product.id }}"
                         data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">Remove</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <a href="/" class="btn btn-link mt-3">Continue shopping</a>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Summary</h5>
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between"><span>Subtotal</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-subtotal">{{ subtotal }}</span></strong></li>
            {% if discount_amount and discount_amount > 0 %}
            <li class="list-group-item d-flex justify-content-between text-success"><span>Coupon{% if coupon %} ({{ coupon.code }}){% endif %}</span><strong>-{{ CURRENCY_SYMBOL }}<span id="cart-discount">{{ discount_amount }}</span></strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Subtotal after discount</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-discounted-subtotal">{{ discounted_subtotal }}</span></strong></li>
            {% else %}
            <li class="list-group-item d-flex justify-content-between"><span>Subtotal after discount</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-discounted-subtotal">{{ subtotal }}</span></strong></li>
            {% endif %}
            <li class="list-group-item d-flex justify-content-between"><span>GST</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-gst">{{ gst_amount }}</span></strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Shipment Charge</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-shipping">{{ shipping }}</span></strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Total</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-total">{{ total }}</span></strong></li>
          </ul>
          <form class="input-group mb-2" method="post" action="/cart/coupon/apply/">
            {% csrf_token %}
            <input class="form-control" name="coupon" placeholder="Enter coupon code" value="{{ coupon_code|default_if_none:""|default:"" }}" />
            <button class="btn btn-outline-light" type="submit">Apply</button>
            {% if coupon_code %}
              <a href="/cart/coupon/remove/" class="btn btn-outline-danger">Remove</a>
            {% endif %}
          </form>
          
          <a href="/checkout/?bn=0" class="btn btn-gradient w-100 mb-2">Proceed to Checkout (All)</a>
          <form id="selectForm" method="post" action="/cart/checkout/selected/">
            {% csrf_token %}
            <button id="proceedSelBtn" class="btn btn-outline-primary w-100" type="submit" disabled>Proceed with selected</button>
          </form>
          <div class="small text-muted mt-2">Free shipping above {{ CURRENCY_SYMBOL }}{{ FREE_SHIPPING_THRESHOLD }}</div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
    <div class="text-center py-5">
      <h4>Your cart is empty</h4>
      <p class="text-muted">Browse products and add your favorites to the cart.</p>
      <a href="/" class="btn btn-primary">Start Shopping</a>
    </div>
  {% endif %}

  {% if saved_items and saved_items|length > 0 %}
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Saved for later</span>
        <a href="/wishlist/" class="btn btn-sm btn-outline-light">View all</a>
      </div>
      <div class="card-body">
        <div class="row g-3">
          {% for s in saved_items %}
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="saved-item card h-100">
                <div class="saved-thumb">
                  <a href="{{ s.link }}" class="d-block h-100 w-100 cart-thumb" data-preview="{% if s.img %}{{ s.img }}{% endif %}">
                    {% if s.img %}
                      <img src="{{ s.img }}" alt="{{ s.product.name }}" />
                    {% else %}
                      <span class="saved-thumb-ph"></span>
                    {% endif %}
                  </a>
                </div>
                <div class="card-body d-flex flex-column">
                  <a href="{{ s.link }}" class="saved-title text-decoration-none fw-semibold">{{ s.product.name }}</a>
                  <div class="mt-1">
                    <span class="fw-semibold">{{ CURRENCY_SYMBOL }}{{ s.price }}</span>
                    {% if s.old_price %}
                      <span class="text-muted text-decoration-line-through ms-1">{{ CURRENCY_SYMBOL }}{{ s.old_price }}</span>
                    {% endif %}
                  </div>
                  <div class="saved-actions d-flex gap-2 mt-auto">
                    <a href="{% url 'move_saved_to_cart' s.product.id %}" class="btn btn-sm btn-outline-primary flex-fill">Move to cart</a>
                    <a href="/wishlist/remove/{{ s.product.id }}/" class="btn btn-sm btn-outline-secondary">Remove</a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
  
  <!-- Image preview modal -->
  <div class="modal fade" id="cartImageModal" tabindex="-1" aria-labelledby="cartImageLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartImageLabel">Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-2">
          <img id="cartPreviewImg" class="cart-preview-img" alt="Product image preview" />
        </div>
      </div>
    </div>
  </div>
  
{% block scripts %}
<script>
  // Open image preview modal on cart-thumb click
  (function(){
    document.addEventListener('click', function(e){
      var a = e.target.closest('a.cart-thumb');
      if (!a) return;
      var src = a.getAttribute('data-preview');
      if (!src) return; // fallback to default link
      e.preventDefault();
      var img = document.getElementById('cartPreviewImg');
      if (img){ img.src = src; }
      var modalEl = document.getElementById('cartImageModal');
      if (modalEl && window.bootstrap){
        var m = bootstrap.Modal.getOrCreateInstance(modalEl);
        m.show();
      }
    });
  })();
</script>
{% endblock %}
{% endblock %}
