{% extends "base.html" %}
{% block content %}
  <h2 class="mb-3">Your Cart</h2>

  {% if cart_items %}
  <div class="row g-4">
    <div class="col-lg-8">
      <!-- Mobile stacked list -->
      <div class="d-block d-md-none">
        <ul class="list-group list-group-flush">
          {% for item in cart_items %}
            <li class="list-group-item cart-row cart-mobile-item" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">
              <div class="d-flex gap-2 align-items-start">
                <div class="cart-media d-flex flex-column align-items-center">
                  <a href="/product/{{ item.product.slug }}/" class="cart-thumb">
                    {% with img=item.product.images.all.0 %}
                      {% if img %}
                        <img src="{{ img.image.url }}" alt="{{ item.product.name }}" />
                      {% else %}
                        <span class="cart-thumb-ph"></span>
                      {% endif %}
                    {% endwith %}
                  </a>
                  <form method="post" action="/cart/update/{{ item.db_item_id|default:0 }}/" class="cart-qty-form mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ item.product.id }}" />
                    <input type="hidden" name="variant_id" value="{% if item.variant %}{{ item.variant.id }}{% endif %}" />
                    <div class="qty-stepper">
                      <button type="button" class="btn btn-outline-secondary btn-sm qty-dec" aria-label="Decrease quantity">−</button>
                      <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control cart-qty-input text-center" />
                      <button type="button" class="btn btn-outline-secondary btn-sm qty-inc" aria-label="Increase quantity">+</button>
                    </div>
                  </form>
                </div>
                <div class="flex-grow-1 min-w-0">
                  <div class="d-flex justify-content-between align-items-start gap-2">
                    <a href="/product/{{ item.product.slug }}/" class="text-decoration-none fw-semibold cart-item-title">{{ item.product.name }}</a>
                    <div class="cart-price fw-semibold text-nowrap">{{ CURRENCY_SYMBOL }}<span class="lt" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">{{ item.line_total }}</span></div>
                  </div>
                  <div class="small text-muted mt-1">{% if item.variant %}Size: {{ item.variant.size }} • Color: {{ item.variant.color }}{% else %}No variant{% endif %}</div>
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <a href="/cart/save/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                       class="btn btn-link text-decoration-none p-0">Save for later</a>
                    <a href="/cart/remove/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                       class="btn btn-link text-danger cart-remove p-0"
                       data-action="/cart/remove/{{ item.db_item_id|default:0 }}/"
                       data-pid="{{ item.product.id }}"
                       data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">Remove</a>
                  </div>
                  <div class="small text-muted mt-1">{{ CURRENCY_SYMBOL }}{{ item.unit_price }} each</div>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Desktop table -->
      <div class="card d-none d-md-block">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr><th>Product</th><th>Variant</th><th style="width:200px">Qty</th><th>Price</th><th>Total</th><th></th></tr>
              </thead>
              <tbody>
                {% for item in cart_items %}
                  <tr class="cart-row" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">
                    <td><a href="/product/{{ item.product.slug }}/" class="text-decoration-none">{{ item.product.name }}</a></td>
                    <td>{% if item.variant %}<span class="badge bg-secondary">{{ item.variant.size }}</span> <span class="badge bg-dark">{{ item.variant.color }}</span>{% else %}-{% endif %}</td>
                    <td>
                      <form method="post" action="/cart/update/{{ item.db_item_id|default:0 }}/" class="d-flex cart-qty-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ item.product.id }}" />
                        <input type="hidden" name="variant_id" value="{% if item.variant %}{{ item.variant.id }}{% endif %}" />
                        <div class="qty-stepper">
                          <button type="button" class="btn btn-outline-secondary btn-sm qty-dec" aria-label="Decrease quantity">−</button>
                          <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control cart-qty-input text-center" />
                          <button type="button" class="btn btn-outline-secondary btn-sm qty-inc" aria-label="Increase quantity">+</button>
                        </div>
                      </form>
                    </td>
                    <td class="text-nowrap">{{ CURRENCY_SYMBOL }}{{ item.unit_price }}</td>
                    <td class="text-nowrap fw-semibold">{{ CURRENCY_SYMBOL }}<span class="lt" data-pid="{{ item.product.id }}" data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">{{ item.line_total }}</span></td>
                    <td class="text-end">
                      <a href="/cart/save/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                         class="btn btn-sm btn-outline-secondary">Save for later</a>
                      <a href="/cart/remove/{{ item.db_item_id|default:0 }}/?product_id={{ item.product.id }}{% if item.variant %}&variant_id={{ item.variant.id }}{% endif %}"
                         class="btn btn-sm btn-outline-danger cart-remove"
                         data-action="/cart/remove/{{ item.db_item_id|default:0 }}/"
                         data-pid="{{ item.product.id }}"
                         data-vid="{% if item.variant %}{{ item.variant.id }}{% else %}0{% endif %}">Remove</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <a href="/" class="btn btn-link mt-3">Continue shopping</a>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Summary</h5>
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between"><span>Subtotal</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-subtotal">{{ subtotal }}</span></strong></li>
            {% if discount_amount and discount_amount > 0 %}
            <li class="list-group-item d-flex justify-content-between text-success"><span>Coupon{% if coupon %} ({{ coupon.code }}){% endif %}</span><strong>-{{ CURRENCY_SYMBOL }}<span id="cart-discount">{{ discount_amount }}</span></strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Subtotal after discount</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-discounted-subtotal">{{ discounted_subtotal }}</span></strong></li>
            {% else %}
            <li class="list-group-item d-flex justify-content-between"><span>Subtotal after discount</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-discounted-subtotal">{{ subtotal }}</span></strong></li>
            {% endif %}
            <li class="list-group-item d-flex justify-content-between"><span>GST</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-gst">{{ gst_amount }}</span></strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Shipment Charge</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-shipping">{{ shipping }}</span></strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Total</span><strong>{{ CURRENCY_SYMBOL }}<span id="cart-total">{{ total }}</span></strong></li>
          </ul>
          <form class="input-group mb-2" method="post" action="/cart/coupon/apply/">
            {% csrf_token %}
            <input class="form-control" name="coupon" placeholder="Enter coupon code" value="{{ coupon_code|default_if_none:""|default:"" }}" />
            <button class="btn btn-outline-light" type="submit">Apply</button>
            {% if coupon_code %}
              <a href="/cart/coupon/remove/" class="btn btn-outline-danger">Remove</a>
            {% endif %}
          </form>
          <a href="/checkout/" class="btn btn-gradient w-100">Proceed to Checkout</a>
          <div class="small text-muted mt-2">Free shipping above {{ CURRENCY_SYMBOL }}{{ FREE_SHIPPING_THRESHOLD }}</div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
    <div class="text-center py-5">
      <h4>Your cart is empty</h4>
      <p class="text-muted">Browse products and add your favorites to the cart.</p>
      <a href="/" class="btn btn-primary">Start Shopping</a>
    </div>
  {% endif %}

  {% if saved_items and saved_items|length > 0 %}
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Saved for later</span>
        <a href="/wishlist/" class="btn btn-sm btn-outline-light">View all</a>
      </div>
      <div class="card-body">
        <div class="row g-3">
          {% for s in saved_items %}
            <div class="col-12 col-md-6">
              <div class="d-flex gap-2 align-items-start">
                <a href="{{ s.link }}" class="cart-thumb" style="width:64px;height:64px;border-radius:8px;overflow:hidden;background:var(--g2);flex-shrink:0;">
                  {% if s.img %}
                    <img src="{{ s.img }}" alt="{{ s.product.name }}" style="width:100%;height:100%;object-fit:cover;display:block;" />
                  {% else %}
                    <span class="cart-thumb-ph" style="display:block;width:100%;height:100%;background:linear-gradient(180deg,var(--g3),var(--g2));"></span>
                  {% endif %}
                </a>
                <div class="flex-grow-1 min-w-0">
                  <a href="{{ s.link }}" class="text-decoration-none fw-semibold d-block" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.25;">{{ s.product.name }}</a>
                  <div class="mt-2 d-flex gap-2">
                    <a href="{% url 'move_saved_to_cart' s.product.id %}" class="btn btn-sm btn-outline-primary">Move to cart</a>
                    <a href="/wishlist/remove/{{ s.product.id }}/" class="btn btn-sm btn-outline-secondary">Remove</a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
